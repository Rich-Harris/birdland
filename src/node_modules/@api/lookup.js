import * as httpie from 'httpie';
import { country_lookup, state_lookup, city_lookup } from '@api/data';

const BASE_URL = `https://api.weatherbit.io/v2.0`;
const { WEATHERBIT_API_KEY: key } = process.env;

export async function get(req, res, next) {
	// const { current, forecast } = sample;

	const { country, state, name } = req.params;
	const slug = `${country}/${state}/${name}`;
	const city = city_lookup.get(slug);

	if (!city) return next(); // 404

	const query = `city_id=${city.id}&key=${key}`;

	const [current, forecast] = await Promise.all([
		httpie.get(`${BASE_URL}/current?${query}`),
		httpie.get(`${BASE_URL}/forecast/daily?${query}`)
	]);

	const result = {
		city,

		current: current.data.data[0],
		forecast: forecast.data.data
	};

	res.send(result);
}

const sample = {
	current: {
		data: {
			data: [{
				"rh": 40,
				"pod": "d",
				"lon": -73.94958,
				"pres": 1009,
				"timezone": "America/New_York",
				"ob_time": "2020-06-09 19:25",
				"country_code": "US",
				"clouds": 25,
				"ts": 1591730700,
				"solar_rad": 867,
				"state_code": "NY",
				"city_name": "Brooklyn",
				"wind_spd": 1.79,
				"last_ob_time": "2020-06-09T19:25:00",
				"wind_cdir_full": "southwest",
				"wind_cdir": "SW",
				"slp": 1012,
				"vis": 5,
				"h_angle": 22.5,
				"sunset": "00:26",
				"dni": 896.13,
				"dewpt": 16.4,
				"snow": 0,
				"uv": 7.6615,
				"precip": 0,
				"wind_dir": 225,
				"sunrise": "09:24",
				"ghi": 873.31,
				"dhi": 117.49,
				"aqi": 141,
				"lat": 40.6501,
				"weather": {
					"icon": "c01d",
					"code": "800",
					"description": "Clear sky"
				},
				"datetime": "2020-06-09:19",
				"temp": 31.7,
				"station": "E1296",
				"elev_angle": 58.44,
				"app_temp": 31.9
			}]
		}
	},

	forecast: {
		data: {
			data: [
				{
					"moonrise_ts": 1591675736,
					"wind_cdir": "SSW",
					"rh": 49,
					"pres": 1011.64,
					"high_temp": 30.6,
					"sunset_ts": 1591748935,
					"ozone": 295.501,
					"moon_phase": 0.656259,
					"wind_gust_spd": 9.7,
					"snow_depth": 0,
					"clouds": 1,
					"ts": 1591675260,
					"sunrise_ts": 1591695028,
					"app_min_temp": 23.2,
					"wind_spd": 3.54111,
					"pop": 0,
					"wind_cdir_full": "south-southwest",
					"slp": 1012.51,
					"moon_phase_lunation": 0.64,
					"valid_date": "2020-06-09",
					"app_max_temp": 30.2,
					"vis": 24.1,
					"dewpt": 15.3,
					"snow": 0,
					"uv": 8.04913,
					"weather": {
						"icon": "c01d",
						"code": 800,
						"description": "Clear Sky"
					},
					"wind_dir": 194,
					"max_dhi": null,
					"clouds_hi": 0,
					"precip": 0,
					"low_temp": 20.6,
					"max_temp": 30.6,
					"moonset_ts": 1591715591,
					"datetime": "2020-06-09",
					"temp": 27.4,
					"min_temp": 21.8,
					"clouds_mid": 0,
					"clouds_low": 1
				},
				{
					"moonrise_ts": 1591764205,
					"wind_cdir": "SE",
					"rh": 83,
					"pres": 1012.73,
					"high_temp": 26.6,
					"sunset_ts": 1591835364,
					"ozone": 286.704,
					"moon_phase": 0.557433,
					"wind_gust_spd": 13.6,
					"snow_depth": 0,
					"clouds": 49,
					"ts": 1591761660,
					"sunrise_ts": 1591781422,
					"app_min_temp": 20.5,
					"wind_spd": 4.0062,
					"pop": 10,
					"wind_cdir_full": "southeast",
					"slp": 1013.61,
					"moon_phase_lunation": 0.67,
					"valid_date": "2020-06-10",
					"app_max_temp": 27.1,
					"vis": 21.1292,
					"dewpt": 19.1,
					"snow": 0,
					"uv": 8.64373,
					"weather": {
						"icon": "c03d",
						"code": 803,
						"description": "Broken clouds"
					},
					"wind_dir": 130,
					"max_dhi": null,
					"clouds_hi": 17,
					"precip": 0.3125,
					"low_temp": 19.9,
					"max_temp": 26.7,
					"moonset_ts": 1591805617,
					"datetime": "2020-06-10",
					"temp": 22.5,
					"min_temp": 19.8,
					"clouds_mid": 5,
					"clouds_low": 47
				},
				{
					"moonrise_ts": 1591852374,
					"wind_cdir": "SW",
					"rh": 68,
					"pres": 1013.25,
					"high_temp": 28.6,
					"sunset_ts": 1591921792,
					"ozone": 291.467,
					"moon_phase": 0.557433,
					"wind_gust_spd": 12.5026,
					"snow_depth": 0,
					"clouds": 100,
					"ts": 1591848060,
					"sunrise_ts": 1591867818,
					"app_min_temp": 23.7,
					"wind_spd": 5.49496,
					"pop": 80,
					"wind_cdir_full": "southwest",
					"slp": 1015.76,
					"moon_phase_lunation": 0.71,
					"valid_date": "2020-06-11",
					"app_max_temp": 28.8,
					"vis": 18.9268,
					"dewpt": 18.4,
					"snow": 0,
					"uv": 3.20915,
					"weather": {
						"icon": "t02d",
						"code": 201,
						"description": "Thunderstorm with rain"
					},
					"wind_dir": 218,
					"max_dhi": null,
					"clouds_hi": 87,
					"precip": 11.375,
					"low_temp": 21.6,
					"max_temp": 28.9,
					"moonset_ts": 1591892017,
					"datetime": "2020-06-11",
					"temp": 25,
					"min_temp": 23.1,
					"clouds_mid": 40,
					"clouds_low": 57
				},
				{
					"moonrise_ts": 1591940341,
					"wind_cdir": "W",
					"rh": 44,
					"pres": 1015.07,
					"high_temp": 30.3,
					"sunset_ts": 1592008217,
					"ozone": 304.241,
					"moon_phase": 0.458036,
					"wind_gust_spd": 7.414,
					"snow_depth": 0,
					"clouds": 42,
					"ts": 1591934460,
					"sunrise_ts": 1591954217,
					"app_min_temp": 21.5,
					"wind_spd": 3.6755,
					"pop": 0,
					"wind_cdir_full": "west",
					"slp": 1017.64,
					"moon_phase_lunation": 0.74,
					"valid_date": "2020-06-12",
					"app_max_temp": 28.6,
					"vis": 24.135,
					"dewpt": 11.6,
					"snow": 0,
					"uv": 9.46842,
					"weather": {
						"icon": "c03d",
						"code": 803,
						"description": "Broken clouds"
					},
					"wind_dir": 278,
					"max_dhi": null,
					"clouds_hi": 42,
					"precip": 0,
					"low_temp": 16.7,
					"max_temp": 30.4,
					"moonset_ts": 1591981946,
					"datetime": "2020-06-12",
					"temp": 25.7,
					"min_temp": 21.6,
					"clouds_mid": 0,
					"clouds_low": 0
				},
				{
					"moonrise_ts": 1592028192,
					"wind_cdir": "W",
					"rh": 39,
					"pres": 1017.24,
					"high_temp": 25.9,
					"sunset_ts": 1592094642,
					"ozone": 318.217,
					"moon_phase": 0.361096,
					"wind_gust_spd": 8.50074,
					"snow_depth": 0,
					"clouds": 10,
					"ts": 1592020860,
					"sunrise_ts": 1592040617,
					"app_min_temp": 16.6,
					"wind_spd": 3.78815,
					"pop": 0,
					"wind_cdir_full": "west",
					"slp": 1019.79,
					"moon_phase_lunation": 0.78,
					"valid_date": "2020-06-13",
					"app_max_temp": 25.1,
					"vis": 24.135,
					"dewpt": 6.2,
					"snow": 0,
					"uv": 10.23,
					"weather": {
						"icon": "c02d",
						"code": 801,
						"description": "Few clouds"
					},
					"wind_dir": 260,
					"max_dhi": null,
					"clouds_hi": 1,
					"precip": 0,
					"low_temp": 16.6,
					"max_temp": 27.1,
					"moonset_ts": 1592071819,
					"datetime": "2020-06-13",
					"temp": 21.2,
					"min_temp": 16.6,
					"clouds_mid": 0,
					"clouds_low": 9
				},
				{
					"moonrise_ts": 1592116002,
					"wind_cdir": "NE",
					"rh": 55,
					"pres": 1020.66,
					"high_temp": 23.4,
					"sunset_ts": 1592181064,
					"ozone": 324.674,
					"moon_phase": 0.269462,
					"wind_gust_spd": 7.20755,
					"snow_depth": 0,
					"clouds": 85,
					"ts": 1592107260,
					"sunrise_ts": 1592127019,
					"app_min_temp": 17.9,
					"wind_spd": 4.05085,
					"pop": 60,
					"wind_cdir_full": "northeast",
					"slp": 1022.84,
					"moon_phase_lunation": 0.81,
					"valid_date": "2020-06-14",
					"app_max_temp": 23.1,
					"vis": 22.4437,
					"dewpt": 10.2,
					"snow": 0,
					"uv": 5.19782,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 46,
					"max_dhi": null,
					"clouds_hi": 72,
					"precip": 4.9375,
					"low_temp": 17.7,
					"max_temp": 24.1,
					"moonset_ts": 1592161685,
					"datetime": "2020-06-14",
					"temp": 19.7,
					"min_temp": 17.8,
					"clouds_mid": 8,
					"clouds_low": 64
				},
				{
					"moonrise_ts": 1592203838,
					"wind_cdir": "ENE",
					"rh": 72,
					"pres": 1022.48,
					"high_temp": 19,
					"sunset_ts": 1592267485,
					"ozone": 348.918,
					"moon_phase": 0.186077,
					"wind_gust_spd": 7.41184,
					"snow_depth": 0,
					"clouds": 99,
					"ts": 1592193660,
					"sunrise_ts": 1592213423,
					"app_min_temp": 17.7,
					"wind_spd": 4.35903,
					"pop": 10,
					"wind_cdir_full": "east-northeast",
					"slp": 1024.46,
					"moon_phase_lunation": 0.84,
					"valid_date": "2020-06-15",
					"app_max_temp": 21,
					"vis": 24.135,
					"dewpt": 13.9,
					"snow": 0,
					"uv": 2.98676,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 64,
					"max_dhi": null,
					"clouds_hi": 18,
					"precip": 0.25,
					"low_temp": 17.4,
					"max_temp": 21.4,
					"moonset_ts": 1592251594,
					"datetime": "2020-06-15",
					"temp": 19.1,
					"min_temp": 17.6,
					"clouds_mid": 8,
					"clouds_low": 98
				},
				{
					"moonrise_ts": 1592291772,
					"wind_cdir": "ENE",
					"rh": 76,
					"pres": 1022.2,
					"high_temp": 25.1,
					"sunset_ts": 1592353904,
					"ozone": 344.277,
					"moon_phase": 0.114121,
					"wind_gust_spd": 5.80012,
					"snow_depth": 0,
					"clouds": 100,
					"ts": 1592280060,
					"sunrise_ts": 1592299829,
					"app_min_temp": 17.4,
					"wind_spd": 3.24847,
					"pop": 55,
					"wind_cdir_full": "east-northeast",
					"slp": 1024.22,
					"moon_phase_lunation": 0.88,
					"valid_date": "2020-06-16",
					"app_max_temp": 18.6,
					"vis": 24.0523,
					"dewpt": 13.9,
					"snow": 0,
					"uv": 2.99283,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 69,
					"max_dhi": null,
					"clouds_hi": 98,
					"precip": 1.25,
					"low_temp": 18,
					"max_temp": 19.1,
					"moonset_ts": 1592341583,
					"datetime": "2020-06-16",
					"temp": 18.2,
					"min_temp": 17.4,
					"clouds_mid": 66,
					"clouds_low": 93
				},
				{
					"moonrise_ts": 1592379880,
					"wind_cdir": "E",
					"rh": 68,
					"pres": 1017.94,
					"high_temp": 28.3,
					"sunset_ts": 1592440322,
					"ozone": 340.877,
					"moon_phase": 0.0570063,
					"wind_gust_spd": 5.01593,
					"snow_depth": 0,
					"clouds": 86,
					"ts": 1592366460,
					"sunrise_ts": 1592386236,
					"app_min_temp": 18,
					"wind_spd": 2.66597,
					"pop": 10,
					"wind_cdir_full": "east",
					"slp": 1020.06,
					"moon_phase_lunation": 0.91,
					"valid_date": "2020-06-17",
					"app_max_temp": 24.9,
					"vis": 24.135,
					"dewpt": 14.3,
					"snow": 0,
					"uv": 4.92836,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 86,
					"max_dhi": null,
					"clouds_hi": 22,
					"precip": 0.3125,
					"low_temp": 18.9,
					"max_temp": 25.1,
					"moonset_ts": 1592431663,
					"datetime": "2020-06-17",
					"temp": 20.7,
					"min_temp": 18,
					"clouds_mid": 5,
					"clouds_low": 69
				},
				{
					"moonrise_ts": 1592468251,
					"wind_cdir": "SW",
					"rh": 61,
					"pres": 1013.65,
					"high_temp": 28.8,
					"sunset_ts": 1592526737,
					"ozone": 324.594,
					"moon_phase": 0.0181774,
					"wind_gust_spd": 5.42945,
					"snow_depth": 0,
					"clouds": 83,
					"ts": 1592452860,
					"sunrise_ts": 1592472646,
					"app_min_temp": 18.9,
					"wind_spd": 2.12264,
					"pop": 10,
					"wind_cdir_full": "southwest",
					"slp": 1015.99,
					"moon_phase_lunation": 0.94,
					"valid_date": "2020-06-18",
					"app_max_temp": 28.1,
					"vis": 24.1349,
					"dewpt": 15.1,
					"snow": 0,
					"uv": 3.00513,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 214,
					"max_dhi": null,
					"clouds_hi": 59,
					"precip": 0.25,
					"low_temp": 19.7,
					"max_temp": 29,
					"moonset_ts": 1592521798,
					"datetime": "2020-06-18",
					"temp": 23.4,
					"min_temp": 18.8,
					"clouds_mid": 69,
					"clouds_low": 33
				},
				{
					"moonrise_ts": 1592556980,
					"wind_cdir": "WSW",
					"rh": 63,
					"pres": 1011.83,
					"high_temp": 32,
					"sunset_ts": 1592613151,
					"ozone": 312.097,
					"moon_phase": 0.000731114,
					"wind_gust_spd": 4.42277,
					"snow_depth": 0,
					"clouds": 50,
					"ts": 1592539260,
					"sunrise_ts": 1592559057,
					"app_min_temp": 22.1,
					"wind_spd": 1.91491,
					"pop": 10,
					"wind_cdir_full": "west-southwest",
					"slp": 1014.38,
					"moon_phase_lunation": 0.98,
					"valid_date": "2020-06-19",
					"app_max_temp": 29.7,
					"vis": 24.1351,
					"dewpt": 16.9,
					"snow": 0,
					"uv": 2.02504,
					"weather": {
						"icon": "c03d",
						"code": 803,
						"description": "Broken clouds"
					},
					"wind_dir": 250,
					"max_dhi": null,
					"clouds_hi": 50,
					"precip": 0.375,
					"low_temp": 20.9,
					"max_temp": 32.4,
					"moonset_ts": 1592611897,
					"datetime": "2020-06-19",
					"temp": 24.5,
					"min_temp": 21.8,
					"clouds_mid": 0,
					"clouds_low": 0
				},
				{
					"moonrise_ts": 1592646149,
					"wind_cdir": "WNW",
					"rh": 61,
					"pres": 1007.86,
					"high_temp": 31.8,
					"sunset_ts": 1592699563,
					"ozone": 306.946,
					"moon_phase": 0.00691809,
					"wind_gust_spd": 8.90819,
					"snow_depth": 0,
					"clouds": 34,
					"ts": 1592625660,
					"sunrise_ts": 1592645470,
					"app_min_temp": 25.1,
					"wind_spd": 5.56376,
					"pop": 25,
					"wind_cdir_full": "west-northwest",
					"slp": 1010.13,
					"moon_phase_lunation": 0.01,
					"valid_date": "2020-06-20",
					"app_max_temp": 28.3,
					"vis": 24.1349,
					"dewpt": 18.1,
					"snow": 0,
					"uv": 1.94448,
					"weather": {
						"icon": "c02d",
						"code": 802,
						"description": "Scattered clouds"
					},
					"wind_dir": 286,
					"max_dhi": null,
					"clouds_hi": 28,
					"precip": 0.875,
					"low_temp": 28.1,
					"max_temp": 31.6,
					"moonset_ts": 1592701824,
					"datetime": "2020-06-20",
					"temp": 26.2,
					"min_temp": 19.1,
					"clouds_mid": 0,
					"clouds_low": 6
				},
				{
					"moonrise_ts": 1592735800,
					"wind_cdir": "ESE",
					"rh": 68,
					"pres": 1013.09,
					"high_temp": 34.4,
					"sunset_ts": 1592785974,
					"ozone": 305.516,
					"moon_phase": 0.0376784,
					"wind_gust_spd": 6.81533,
					"snow_depth": 0,
					"clouds": 26,
					"ts": 1592712060,
					"sunrise_ts": 1592731885,
					"app_min_temp": 19.5,
					"wind_spd": 4.17736,
					"pop": 0,
					"wind_cdir_full": "east-southeast",
					"slp": 1014.82,
					"moon_phase_lunation": 0.05,
					"valid_date": "2020-06-21",
					"app_max_temp": 20.9,
					"vis": 24.1352,
					"dewpt": 14.3,
					"snow": 0,
					"uv": 2.25997,
					"weather": {
						"icon": "c02d",
						"code": 802,
						"description": "Scattered clouds"
					},
					"wind_dir": 109,
					"max_dhi": null,
					"clouds_hi": 2,
					"precip": 0,
					"low_temp": 30.4,
					"max_temp": 26.3,
					"moonset_ts": 1592791443,
					"datetime": "2020-06-21",
					"temp": 20.3,
					"min_temp": 19.7,
					"clouds_mid": 5,
					"clouds_low": 19
				},
				{
					"moonrise_ts": 1592825890,
					"wind_cdir": "W",
					"rh": 58,
					"pres": 1007.02,
					"high_temp": 34.3,
					"sunset_ts": 1592872382,
					"ozone": 314.964,
					"moon_phase": 0.0923873,
					"wind_gust_spd": 8.31927,
					"snow_depth": 0,
					"clouds": 88,
					"ts": 1592798460,
					"sunrise_ts": 1592818302,
					"app_min_temp": 23.5,
					"wind_spd": 4.0428,
					"pop": 50,
					"wind_cdir_full": "west",
					"slp": 1009.32,
					"moon_phase_lunation": 0.08,
					"valid_date": "2020-06-22",
					"app_max_temp": 32.4,
					"vis": 24.1352,
					"dewpt": 17.8,
					"snow": 0,
					"uv": 1.04562,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 263,
					"max_dhi": null,
					"clouds_hi": 71,
					"precip": 3.25,
					"low_temp": 25.6,
					"max_temp": 34.3,
					"moonset_ts": 1592880677,
					"datetime": "2020-06-22",
					"temp": 27.6,
					"min_temp": 23.1,
					"clouds_mid": 34,
					"clouds_low": 38
				},
				{
					"moonrise_ts": 1592916299,
					"wind_cdir": "NW",
					"rh": 55,
					"pres": 1006.43,
					"high_temp": 34.4,
					"sunset_ts": 1592958788,
					"ozone": 316.1,
					"moon_phase": 0.168855,
					"wind_gust_spd": 6.40017,
					"snow_depth": 0,
					"clouds": 87,
					"ts": 1592884860,
					"sunrise_ts": 1592904720,
					"app_min_temp": 28.5,
					"wind_spd": 4.17261,
					"pop": 45,
					"wind_cdir_full": "northwest",
					"slp": 1008.74,
					"moon_phase_lunation": 0.11,
					"valid_date": "2020-06-23",
					"app_max_temp": 31.9,
					"vis": 24.135,
					"dewpt": 18.6,
					"snow": 0,
					"uv": 1.18423,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 307,
					"max_dhi": null,
					"clouds_hi": 86,
					"precip": 2.5,
					"low_temp": 26,
					"max_temp": 34.4,
					"moonset_ts": 1592969530,
					"datetime": "2020-06-23",
					"temp": 29.3,
					"min_temp": 26,
					"clouds_mid": 25,
					"clouds_low": 2
				},
				{
					"moonrise_ts": 1593006880,
					"wind_cdir": "WSW",
					"rh": 49,
					"pres": 1008.34,
					"high_temp": 37.1,
					"sunset_ts": 1593045193,
					"ozone": 319.085,
					"moon_phase": 0.263485,
					"wind_gust_spd": 7.40748,
					"snow_depth": 0,
					"clouds": 80,
					"ts": 1592971260,
					"sunrise_ts": 1592991140,
					"app_min_temp": 29.3,
					"wind_spd": 3.42827,
					"pop": 20,
					"wind_cdir_full": "west-southwest",
					"slp": 1010.75,
					"moon_phase_lunation": 0.15,
					"valid_date": "2020-06-24",
					"app_max_temp": 36.1,
					"vis": 24.1351,
					"dewpt": 19,
					"snow": 0,
					"uv": 1.11468,
					"weather": {
						"icon": "c04d",
						"code": 804,
						"description": "Overcast clouds"
					},
					"wind_dir": 254,
					"max_dhi": null,
					"clouds_hi": 78,
					"precip": 0.75,
					"low_temp": 28.8,
					"max_temp": 37.1,
					"moonset_ts": 1592971665,
					"datetime": "2020-06-24",
					"temp": 31.2,
					"min_temp": 28.1,
					"clouds_mid": 24,
					"clouds_low": 6
				}
			],
			"city_name": "Brooklyn",
			"lon": "-73.94958",
			"timezone": "America/New_York",
			"lat": "40.6501",
			"country_code": "US",
			"state_code": "NY"
		}
	}
};